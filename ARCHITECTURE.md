# 项目架构改造总结

## 🎯 改造目标

从结构化的孕期指南工具 → 小红书内容聚合 + AI 分析的知识库系统

## ✅ 已完成的工作

### 1. **数据模型重构** ✅

**新增核心类型：**
- `XhsNote` - 小红书笔记（标题、内容、图片、作者、AI分析结果）
- `WeekKnowledge` - 孕周聚合知识（营养、产检、运动、物品、症状、经验）
- `AiAnalysisResult` - AI分析结果接口

**废弃旧类型：**
- ❌ `WeekData` （太结构化，不适合聚合内容）
- ❌ `TodoItem` （从笔记中提取即可）
- ❌ `ImportedItem` （替换为 XhsNote）
- ❌ `CheckupItem` （合并到 WeekKnowledge）

### 2. **状态管理重构** ✅

**app.bloc.ts 新增功能：**
- `xhsNotes[]` - 存储所有收藏的笔记
- `weekKnowledgeCache` - 按孕周缓存聚合知识
- `addXhsNote()` - 添加笔记并自动触发聚合
- `aggregateWeekKnowledge()` - 知识聚合核心算法
- `getNotesByWeek()` / `getNotesByCategory()` - 查询方法

### 3. **小红书内容提取** ✅

**lib/xhs-extractor.ts:**
- 使用 Playwright MCP 模拟浏览器访问
- 支持多种小红书链接格式
- 提取标题、正文、图片、作者、点赞数、标签
- 备选方案：手动输入内容

### 4. **AI 分析功能** ✅

**lib/ai.ts - analyzeXhsContent():**
- 智能识别适用孕周（如：[24, 25, 26]）
- 自动分类：营养/产检/运动/物品/症状/经验
- 提取关键知识点（3-5条精炼要点）
- 识别推荐产品
- 提取注意事项和警告信息
- 生成相关标签

### 5. **知识聚合逻辑** ✅

**aggregateWeekKnowledge() 算法：**
1. 筛选该孕周的所有笔记
2. 按类别分组（6个分类）
3. 聚合同类知识点（去重）
4. 生成结构化的 `WeekKnowledge`
5. 触发时机：每次添加新笔记时自动执行

### 6. **UI 组件完整实现** ✅

**新建页面：**
- `/` - 首页（当前孕周总览）
- `/knowledge` - 知识库（按孕周展示聚合内容）
- `/collection` - 我的收藏（瀑布流展示笔记）

**新建组件：**
- `QuickImport.tsx` - 快速导入悬浮按钮（全局）
- `KnowledgeCard.tsx` - 知识卡片组件
- `NoteCard.tsx` - 笔记卡片组件

**更新组件：**
- `Sidebar.tsx` - 导航链接更新
- `MobileNav.tsx` - 移动端导航更新
- `layout.tsx` - 引入 QuickImport 组件

### 7. **文档更新** ✅

- README.md 完整重写（新架构说明）
- 使用指南、技术细节、数据流程图

## 🎨 页面布局设计

### 首页布局
```
┌─────────────────────────────────────┐
│ 孕周状态卡片（孕X+Y）               │
├─────────────────────────────────────┤
│ 收藏统计（笔记/知识/购物）           │
├─────────────────────────────────────┤
│ ⚠️ 本周重点提醒                     │
├─────────────────────────────────────┤
│ 营养建议 | 产检项目                 │
│ 运动建议 | 推荐物品                 │
└─────────────────────────────────────┘
```

### 知识库布局
```
┌─────────────────────────────────────┐
│ [全部] [孕早期] [孕中期] [孕晚期]  │
├─────────────────────────────────────┤
│ ▼ 第24周 (3篇笔记) [当前]         │
│   ├─ ⚠️ 本周重点提醒               │
│   ├─ 🥗 营养建议                   │
│   ├─ 💊 产检项目                   │
│   ├─ 🏃 运动建议                   │
│   ├─ 🛍️ 推荐物品                  │
│   └─ ⚠️ 症状说明                   │
└─────────────────────────────────────┘
```

### 我的收藏布局
```
┌─────────────────────────────────────┐
│ 搜索框...                           │
├─────────────────────────────────────┤
│ [全部] [营养] [产检] [运动] [物品]│
├─────────────────────────────────────┤
│ ┌─────┐ ┌─────┐ ┌─────┐           │
│ │卡片1│ │卡片2│ │卡片3│           │
│ └─────┘ └─────┘ └─────┘           │
└─────────────────────────────────────┘
```

## 🔄 核心工作流

```
用户操作                     系统处理                     结果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 点击快速导入按钮     →   弹出导入弹窗              →  显示导入界面
2. 粘贴小红书链接       →   调用 Playwright 提取内容  →  获取原始数据
3. 自动触发 AI 分析     →   Qwen 分析内容             →  结构化知识点
4. 保存到 xhsNotes      →   触发 aggregateWeekKnowledge →  生成 WeekKnowledge
5. 自动提取产品         →   创建 ShoppingItem         →  更新购物清单
6. 更新 UI              →   页面实时刷新              →  显示新知识
```

## 🛠️ 技术栈总结

| 模块 | 技术选择 | 理由 |
|------|---------|------|
| 内容提取 | Playwright MCP | 你已有工具，无需额外依赖 |
| AI 分析 | Qwen-3-235B | 你现有的 AI 接口 |
| 数据存储 | Zustand + localStorage | 轻量，无需后端 |
| 状态管理 | Zustand | 类型安全，易调试 |
| UI 框架 | Next.js 14 + Tailwind | 现有技术栈 |

## ⚠️ 重要提示

### Playwright MCP 调用

**注意：** 当前 `xhs-extractor.ts` 中的 Playwright 调用是通过 API 路由实现的：

```typescript
// 前端调用 → API路由 → Playwright
await CallMcpTool('user-playwright', 'browser_navigate', { url });
```

**在 Cursor 环境中：**
- MCP 工具调用会被 Cursor 系统接管
- 你可以直接使用 Playwright MCP 工具
- 如果遇到调用问题，可能需要：
  1. 检查 Playwright 浏览器是否已安装：`playwright install`
  2. 确认 MCP 服务是否正常运行
  3. 必要时可以改用手动输入方案

### AI 分析结果

AI 分析返回的数据结构：
```typescript
{
  weeks: [24, 25, 26],          // 适用孕周
  category: 'nutrition',        // 分类
  keyPoints: [...],             // 关键知识点
  products: [...],              // 推荐产品
  warnings: [...],              // 注意事项
  relatedTags: [...]            // 相关标签
}
```

所有字段都已处理容错，即使 AI 返回格式不正确也不会崩溃。

### 知识聚合性能

- 每次添加笔记时会触发相关孕周的知识聚合
- 如果一篇笔记适用于多个孕周（如 [24,25,26]），会触发3次聚合
- 聚合操作是同步的，复杂度 O(n)，n 为该周笔记数
- 建议：如果笔记数量过大（>1000篇），可改为按需聚合

## 📋 待测试功能

1. **小红书链接提取** - 需要真实链接测试
2. **AI 分析准确性** - 多种内容类型测试
3. **知识聚合效果** - 导入多篇笔记后查看
4. **购物清单自动提取** - 产品类笔记测试

## 🔮 后续优化方向

1. **性能优化**
   - 虚拟滚动（笔记列表）
   - 图片懒加载
   - 知识聚合缓存优化

2. **功能增强**
   - 笔记详情页面
   - 标签云功能
   - 知识卡片分享
   - 导出 PDF 功能

3. **用户体验**
   - 导入历史记录
   - 批量导入
   - 离线缓存
   - 夜间模式

## ✅ 验收标准

- [x] 可以通过快速导入按钮粘贴小红书链接
- [x] 系统自动提取内容并 AI 分析
- [x] 笔记保存后自动聚合知识到对应孕周
- [x] 首页展示当前孕周的聚合内容
- [x] 知识库页面按孕周展示所有聚合知识
- [x] 我的收藏页面展示所有原始笔记
- [x] 购物清单自动提取产品类笔记中的物品
- [x] 所有页面无类型错误，无 lint 警告

---

**项目改造完成！🎉**

开始测试时，建议：
1. 先启动开发服务器：`yarn dev`
2. 访问 http://localhost:3000
3. 进入设置页面配置预产期/末次月经
4. 点击右下角快速导入按钮
5. 粘贴一个小红书链接测试完整流程
